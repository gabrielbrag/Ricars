{% extends 'erp/masterpage.html' %}

{% block stylesheets %}
  {% load static %}
  <script src="{% static 'erp/js/vehicle_edit.js' %}"></script> 
{% endblock %}

{% block content %}
<form method="post" enctype="multipart/form-data">
  {% load i18n %}
  {% csrf_token %}

  <div class="form-group">
    <label for="id_brand">{% trans 'Brand' %}</label>
    <select name="brand" id="id_brand" class="form-control">
    </select>
  </div>

  <div class="form-group">
    <label for="id_model">{% trans 'Model' %}</label>
    <select name="vehicle_model" id="id_model" class="form-control" disabled>
      <option value="">---------</option>
    </select>
  </div>

  <div class="form-group">
    <label for="id_variant">{% trans 'Variant' %}</label>
    <select name="vehicle_variant" id="id_variant" class="form-control" disabled>
      <option value="">---------</option>
    </select>
  </div>

  {% for field in form %}
    {% if field.name != 'vehicle_variant' %}
    <div class="form-group">
      {{ field.label_tag }}
      {{ field }}
      {% if field.errors %}
      <div class="errors">
        {% for error in field.errors %}
        <span class="error">{{ error }}</span>
        {% endfor %}
      </div>
      {% endif %}
    </div>
    {% endif %}
  {% endfor %}

  <input type="file" name="images_input" multiple>
  <div class="card mt-3 mb-3">
    <div id="thumbnail-container" class="thumbnail-container card-body">
      {% for image in vehicle.images.all %}
        <div class="thumbnail">
          <img src="{{ image.file.url }}" alt="Thumbnail" data-id="{{ image.pk }}">
          <span class="delete-button" data-id="{{ image.pk }}">
              <i class="fas fa-trash"></i>
          </span>
        </div>
      {% endfor %}
  </div>
</div>

  <button type="submit" class="btn btn-primary">Save</button>
</form>

<script>
  const fileInput = document.querySelector('input[name="images_input"]');
  fileInput.addEventListener('change', handleFileSelect);

  $(document).ready(function () {
    var brandURL    = "{% url 'brand_json' %}";
    var modelUrl    = "{% url 'vehicle_model_json' %}";
    var variantUrl  = "{% url 'vehicle_model_variant_json' %}";
    var listURL     = "{% url 'vehicle_list' %}"

    setUpEndpoints(brandURL, modelUrl, variantUrl, listURL);

    loadBrand({{ vehicle_brand.pk|default:"null" }}, {{ vehicle.vehicle_variant.vehicle_model.pk|default:"null" }}, {{ vehicle.vehicle_variant.pk|default:"null" }})

    $("#id_brand").change(function () {
      var brandId = $(this).val();
      loadModel(brandId, null, null);
    });

    // Load variants for the selected model
    $("#id_model").change(function () {
      var modelId = $(this).val();
      loadVariant(modelId, null);
    })

    insertedFiles = [];
    existingFilesIDs = [];

    var allImages = $('img');

    // Loop through the selected <img> elements
    allImages.each(function(index) {
      // Do something with each <img> element, for example, access its attributes
      let data_id = $(this).attr('data-id');

      if (data_id){
        existingFilesIDs.push(data_id)
      };
    });

    thumbnailDivs = $('.thumbnail');

    thumbnailDivs.each(function() {
          var thumbnail = this; // 'this' refers to the current thumbnail div

          // Find the delete button inside the current thumbnail div
          var deleteButton = $(thumbnail).find('.delete-button');

          // Add a click event listener to the delete button
          deleteButton.on('click', function() {
            let emptyName = "";
            handleDeleteImage($(this).data("id"), thumbnail, emptyName); 
          });
      });
 
      const form = document.querySelector("form");
 
      form.addEventListener("submit", function (event) {
        event.preventDefault();
        submitWithFiles(form);
      });
  });
</script>
{% endblock %}